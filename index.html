<!DOCTYPE html> 
<html> 
	<head> 
	<title>English irregular verbs</title> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0b1/jquery.mobile-1.0b1.min.css" />
        <script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0b1/jquery.mobile-1.0b1.min.js"></script>
                
        <script src="js/jquery/jquery-ui-1.8.13.bounceEffect.min.js"></script>
                
        <!-- kibo -->      
       	
	<style>						
                .tenses div{
                    width:20%;
                    height:5em;
                    background:green;
                    margin-bottom:1em;
                }
                
                .options div{
                    width:10%;
                    height:2em;
                    background:yellow;
                    margin-bottom:1em;
                }
                                                 
               .center{text-align: center;}
               
               #nextButton{                                           
                   display:none;
               }
                              
	</style>
	
    <script>
        var DICTIONARY = {}
        
        DICTIONARY.game = (function(){
            var data;
            var idx;
            var utils;         
            var tenses;
            var setting;
            var topten;
            var errorManager;
            var sound = new Audio();
            var lives = localStorage.getItem("lives") != null ? localStorage.getItem("lives") : 3;
            var countOfVerbs = localStorage.getItem("countOfVerbs") != null ? localStorage.getItem("countOfVerbs") : 10;     
            var voice = localStorage.getItem("voice") != null ? localStorage.getItem("voice") : 'on';  
            var bonus = 0;
            
            function init(){             
                //localStorage.clear();
                jQuery.event.props.push('dataTransfer');
                utils = DICTIONARY.utils();
                errorManager = DICTIONARY.errorManager();
                data = getData();             
                setting = DICTIONARY.setting();
                topten = DICTIONARY.topten();                
                idx = DICTIONARY.idx();   
                tenses = DICTIONARY.tenses();                           
                showTense();
                showOptions();
                bindEvents();
                showStatus();
                showTopTen();
                showVerbsList();
                showSetting();                                
            }
            
            function getData(){
                var data = utils.shuffle( DICTIONARY.data().get() );
                var errors = errorManager.get();
                               
                //errors from last game first
                for(var i=0; i < errors.length; i++){                                                                           
                    var indx = utils.hasObject( data, errors[i] );                   
                    var verb = data[indx];                                                         
                    data.splice(indx,1);
                    data.push(verb);                    
                }
                
                data.reverse();                
                return data;
            }
                                                           
            function getVerb(){
                return data[ idx.get() ];
            }
            
            function nextVerb(){
                idx.next();
                showTense(); 
                showOptions();
                switchNextButton();
            }
                                   
            function getOptions(){
                var options = [ getVerb().tenses[0],
                                getVerb().tenses[1],
                                getVerb().tenses[2],
                                getVerb().fakes[0],
                                getVerb().fakes[1] 
                             ];
                return utils.shuffle( options );                             
            }
            
            function showTense(){
                tenses.unlock();
                var random = utils.random();
                var tense = getVerb().tenses[random];
                var selector = "#tense" + random;
                $( selector ).text( tense );
                $( selector ).attr("ondragover", "return true");                
            }                                                                      
            
            function showOptions(){
                $('.options').empty();
                var options = getOptions();
                for(var i = 0; i <= ( options.length - 1 ); i++){                              
                    $('.options').append('<div draggable="true" >' + options[i] + '</div>');                                                                             
                }
                $('.options div').bind('dragstart', function(event){
                    event.dataTransfer.setData("text",  $(event.target).text() );                     
                    return true;                                        
                });                                            
            }
                                 
            function playSound(){
                sound.setAttribute("src", getVerb().sound  );;
                sound.play();
            }
            
            function switchNextButton(){
                if (  $("#nextButton").is(':hidden') ){            
                    $("#nextButton").show();
                }else{
                    $("#nextButton").hide();              
                }                  
            }
            
            function showStatus(){                      
                $(".bonus").text( bonus );
                $(".lives").text( lives ); 
                checkStatus();
            }
            
            function showSetting(){
                $("#select-lives").val( lives );
                $("#select-verbs").val( countOfVerbs );  
                $("#select-voice").val( voice ); 
            }
            
            function showTopTen(){                 
                 $("#toptenList").empty();  
                 var toptenArray = topten.get();                 
                 for(var i = 0; i < toptenArray.length; i++){ 
                     var name = '<h3>' + toptenArray[i].name + '</h3>';
                     var date = '<p class="ui-li-aside">' + toptenArray[i].date + '</p>';
                     var bonus = '<p class="ui-li-count">' + toptenArray[i].bonus + '</p>';
                     $("#toptenList").append('<li>' + name + date + bonus + '</li>');                    
                 }                                                
            }
            
            function showVerbsList(){
                $("#verbsList").empty();
                var verbs = DICTIONARY.data().get();
                var head;
                for(var i=0; i < verbs.length; i++){
                                                        
                    $("#verbsList").append( 
                        ((head != verbs[i].tenses[0][0].toUpperCase() ) ? '<li data-role="list-divider">' + verbs[i].tenses[0][0].toUpperCase() + '</li>' : '') + 
                        '<li data-icon="info"> \
                            <a href="#"> \
                                <h3>' + verbs[i].tenses[0] + '</h3> \
                                <p>' + verbs[i].tenses[0] +', ' + verbs[i].tenses[1] + ', ' + verbs[i].tenses[2] + '</p> \
                            </a> \
                        </li>\
                        ');   
                    
                    head = verbs[i].tenses[0][0].toUpperCase();                    
                }                         
            }
            
            function checkStatus(){         
               if(lives <= 0){                              
                   $("#state").text( "GAME OVER!" );
                   $.mobile.changePage("#gameover");
               }else if( idx.get() >= countOfVerbs-1){              
                   $(".bonus").text( (bonus * lives) );
                   $("#state").text( "YOU ARE WINNER!" );
                   $.mobile.changePage("#gameover");
               }           
            }
            
            function bindEvents(){      
                $('.tenses div').bind('drop', function(event){
                    event.stopPropagation();
                    event.preventDefault();
                    var text = event.dataTransfer.getData("text");                   
                    $(event.target).text(text);  
                    if ($("#tense0").text() && 
                        $("#tense1").text() && 
                        $("#tense2").text() ){
                            tenses.lock();
                            var isError = tenses.check( getVerb() );
                            if(isError){
                                lives--;
                                errorManager.add(  getVerb() );
                            }else{
                                bonus++;
                                errorManager.remove( getVerb() );
                            }                                                       
                            showStatus();
                            switchNextButton();
                            if(voice == 'on'){
                                playSound();
                            }                            
                    }                       
                });     
                
                $('#nextButton').click( function(){nextVerb()} );
                $("#soundButton").click(function(){ playSound();});
                
                $('#select-lives').change( function(event){ setting.set( event.target ); } );
                $('#select-verbs').change( function(event){ setting.set( event.target ); } );  
                $('#select-voice').change( function(event){ setting.set( event.target ); } );   
                
                $('#saveResultsButton').click( function(){ 
                    topten.save( bonus, $("#name").val() ); 
                    showTopTen();
                    $.mobile.changePage("#topten");
                } );
            }
                                                          
            return{
                init: init 
            }
            
        })();
        
        DICTIONARY.tenses = function(){
        
            function lock(){
                for(var i = 0; i<=2; i++){               
                    $("#tense" + i).attr("ondragover", "return true");
                }
            }
            
           function unlock(){
               for(var i = 0; i<=2; i++){   
                   $("#tense" + i).text("");
                   $("#tense" + i).attr("ondragover", "return false");
               }           
            }
            
           function check( verb ){              
                var isError = false;
                for(var i = 0; i<=2; i++){                 
                    if( $("#tense" + i).text() != verb.tenses[i] ){
                        isError = true;
                        $("#tense" + i ).effect("bounce", { times:3 }, 200);                
                    }                  
                } 
                
                return isError;                          
            }
            
            return{
                lock: lock,
                check: check,
                unlock: unlock
            }                                
        } 
        
        DICTIONARY.topten = function(){
            
            function save(bonus, name){                   
                var topten =  localStorage.getItem("topten") != null ?
                                    JSON.parse( localStorage.getItem("topten") ) :
                                    [];                                
                topten.push( {"date":today(), "name":name, "bonus":bonus} );
                topten.sort( compare );
                topten.reverse();                
                if(topten.length >= 11){ //max 10 items
                    topten.pop();
                }
                localStorage.setItem( "topten", JSON.stringify( topten ) );                                                                      
            }
                          
            function get(){               
                return localStorage.getItem("topten") != null ?
                                    JSON.parse( localStorage.getItem("topten") ) :
                                    [];                                                                             
            }
            
            function today(){
                var now = new Date();
                return now.getDate() + "." + (now.getMonth()+1) + "."  + now.getFullYear();
            }
            
            function compare(a, b){
                if (a.bonus < b.bonus)
                    return -1;
                if (a.bonus > b.bonus)
                    return 1;
                return 0;
            }
                                                        
            return{
                save: save,   
                get: get  
            }            
        }
                      
        DICTIONARY.errorManager = function(){
            
            var utils = DICTIONARY.utils();
            
            function get(){
                return localStorage.getItem("errors") != null ?
                                    JSON.parse( localStorage.getItem("errors") ) :
                                    []; 
            }
            
            function add( verb ){                
                var errors =  localStorage.getItem("errors") != null ?
                                    JSON.parse( localStorage.getItem("errors") ) :
                                    [];                                                                                            
               
               var index = utils.hasObject( errors, verb ); 
               if ( index == -1 ){                    
                    errors.push(verb);  
                    localStorage.setItem( "errors", JSON.stringify(errors) ); 
                }                                                                                                        
            }
            
            function remove( verb ){
                var errors =  localStorage.getItem("errors") != null ?
                                    JSON.parse( localStorage.getItem("errors") ) :
                                    [];
                var index = utils.hasObject( errors, verb );                   
                if ( index != -1){
                    errors.splice(index,1);
                    localStorage.setItem( "errors", JSON.stringify(errors) ); 
                }               
            }
            
            return{
                get: get,
                add: add,
                remove: remove
            }
            
        }
        
        DICTIONARY.setting = function(){
            
            function set( id ){
                var name = $(id).attr("name"); 
                var value = $(id).val();
                localStorage.setItem( name, value );
            }
            
            return {
                set: set
            }
            
        }
                                
        DICTIONARY.idx = function(){
            var n = 0;  
            
            function get(){
                return n;
            }
            
            function next(){
                (n >= ( DICTIONARY.data().get().length - 1) ) ? n = 0 :  n++;               
            }
            
            return {
                next: next,
                get: get               
            };              
         };  
         
         DICTIONARY.utils = function(){
             
             function shuffle(o){
                for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
                return o;
             }
             
             //0-2
             function random(){
                return Math.round( Math.random() * 2 );
             };
                         
             //return index or -1 (the same as indexOf)
             function hasObject( data, obj ){
                 
                 for(key in data){
                    if(data[key].id == obj.id)
                        return key;
                 }
                 
                 return -1;
             }
                                            
             return{
                 random: random,
                 shuffle: shuffle,
                 hasObject: hasObject
             }
         }
        
        DICTIONARY.data = function(){
                        
            function get(){   
                var data = [
                   {"id":1, "tenses":["have","had","had"], "fakes":["afake1", "bfake2"], "sound":"data/have.mp3"},
                   {"id":2, "tenses":["do","did","done"], "fakes":["efake1", "ffake2"], "sound":"data/have.mp3"},
                   {"id":3, "tenses":["set","set","set"], "fakes":["sett", "sed"], "sound":"data/set.mp3"},
                   {"id":4, "tenses":["shut","shut","shut"], "fakes":["sutt", "sud"], "sound":"data/have.mp3"},
                   {"id":5, "tenses":["be","were","been"], "fakes":["ifake1", "jfake2"], "sound":"data/have.mp3"}               
                ]; 
                
                return data;
            }
                             
            return{
                get: get
            }
        }
        
        
        function playSound(){
            var snd = new Audio("data/have.mp3");
            snd.play();
        }
        
        $(document).ready(function(){         
            DICTIONARY.game.init();
        });
                             
    </script>	
			
</head> 
<body> 
    
 <div data-role="page" data-theme="b" id="home">
     
    <div data-role="header" data-position="fixed">            
            <h1>Home</h1>					           
    </div><!-- /header -->

    <div data-role="content" >	
	                         
            <a href="#game" data-role="button" >Game</a>            
            <a href="#topten" data-role="button">Top ten</a>
            <a href="#search" data-role="button" >Search</a> 
            <a href="#about" data-role="button">About</a>     
                                            	
    </div><!-- /content -->

   <div data-role="footer" data-position="fixed"  class="ui-bar">         
        <a href="#options" data-role="button" data-icon="gear">Options</a>                                                              
    </div><!-- /footer -->
        
 </div> <!-- /home -->
 
 
  <div data-role="page" data-theme="b" id="topten">
     
      <div data-role="header" data-position="fixed"> 
            <a href="#home" onclick="window.location.href='index.html'" data-role="button" data-icon="home" data-iconpos="notext" title="home">Home</a>            
            <h1>Top ten</h1>					           
    </div><!-- /header -->

    <div data-role="content" >	
        
        <ol id="toptenList" data-role="listview" data-theme="c"  data-count-theme="b"></ol>    	                           	
        
    </div><!-- /content -->

   <div data-role="footer" data-position="fixed" class="ui-bar" data-inline="true">                                                                            
    </div><!-- /footer -->
        
 </div> <!-- /result -->
 
  <div data-role="page" data-theme="b" id="search">
     
      <div data-role="header" data-position="fixed">                  
            <a href="#home" onclick="window.location.href='index.html'" data-role="button" data-icon="home" data-iconpos="notext" title="home">Home</a> 
            <h1>Search</h1>					           
    </div><!-- /header -->

    <div data-role="content" >	
        
        <ul id="verbsList" data-role="listview" data-filter="true" data-filter-placeholder="Search verb" data-filter-theme="b"></ul>   
        
    </div><!-- /content -->

   <div data-role="footer" data-position="fixed" class="ui-bar" data-inline="true">                                                                            
    </div><!-- /footer -->
        
 </div> <!-- /search -->
 
 
  
<div data-role="page" data-theme="b" id="game">

    <div data-role="header" data-position="fixed">
            <a href="#home" onclick="window.location.href='index.html'" data-role="button" data-icon="home" data-iconpos="notext" title="home">Home</a> 
            <h1>Game</h1>					           
    </div><!-- /header -->

    <div data-role="content" >	
	  
        <div class="tenses">
            <div id="tense0" ondragover="return false"></div>
            <div id="tense1" ondragover="return false"></div>
            <div id="tense2" ondragover="return false"></div>
        </div>

        <div class="options"></div>
                               
        <div class="ui-grid-a" >
            <div class="ui-block-a"><button id="soundButton" type="button" data-theme="c" data-icon="info" data-iconpos="right" title="Sound">Sound</button></div>
            <div class="ui-block-b"><div id="nextButton"><button type="button" data-theme="b" data-icon="arrow-r" data-iconpos="right" title="Next" >Next</button></div></div>	   
        </div>                 	
    </div><!-- /content -->

    <div data-role="footer" data-position="fixed" class="ui-bar" data-inline="true">        
        <div class="ui-grid-a">
            <div class="ui-block-a"><span class="bonus" ></span></div>
            <div class="ui-block-b"><span class="lives"></span></div>	   
        </div>                                                               
    </div><!-- /footer -->

</div><!-- /game -->


<div data-role="page" data-theme="b" id="gameover">
        
    <div data-role="header" data-position="fixed">
            <a href="#home" onclick="window.location.href='index.html'"  data-role="button" data-icon="home" data-iconpos="notext" title="home">Home</a> 
            <h1>Game over</h1>					           
    </div><!-- /header -->

    <div data-role="content" >	
	         
        <h2 id="state" class="center"></h2>
        <h4 class="bonus center"></h4>
                                      
        <div data-role="fieldcontain">            
        	<label for="name">Name:</label>
                <input type="text" name="name" id="name" value="" placeholder="your name"  />                  
         
                <div class="ui-grid-a">
                    <div class="ui-block-a"><button type="button" data-theme="c" onclick="window.location.href='index.html'">Cancel</button></div>
                    <div class="ui-block-b"><button id="saveResultsButton" type="button" data-theme="b">Save</button></div>	   
                </div>
        </div> 
                	
    </div><!-- /content -->

     <div data-role="footer" data-position="fixed" class="ui-bar" data-inline="true">                                                                              
    </div><!-- /footer -->
            
</div> <!-- /gameOver -->

<div data-role="page" data-theme="b" id="options">
        
    <div data-role="header" data-position="fixed">
            <a href="#home" onclick="window.location.href='index.html'"  data-role="button" data-icon="home" data-iconpos="notext" title="home">Home</a> 
            <h1>Options</h1>					           
    </div><!-- /header -->

    <div data-role="content" >
        
         <div data-role="fieldcontain">
            <label for="select-lives" class="select">Count of lives:</label>
            <select name="lives" id="select-lives" data-native-menu="false" >
                <option value="3">3 lives</option>  
                <option value="2">2 lives</option>
                <option value="1">1 live</option>                                                                         
            </select>
        </div>
                                                
        <div data-role="fieldcontain">
            <label for="select-verbs" class="select">Count of verbs:</label>
            <select name="countOfVerbs" id="select-verbs" data-native-menu="false" >                    
                    <option value="10">10 verbs</option>
                    <option value="20">20 verbs</option>
                    <option value="30">30 verbs</option>
                    <option value="30">40 verbs</option>
                    <option value="30">50 verbs</option>
                    <option value="100">100 verbs</option>
            </select>
        </div>
        
        <div data-role="fieldcontain">
                <label for="select-voice">Play sound:</label>
                <select name="voice" id="select-voice" data-role="slider">
                    <option value="on">On</option>
                    <option value="off">Off</option>                        
                </select> 
        </div>

        
        
               	                                        
    </div><!-- /content -->

     <div data-role="footer" data-position="fixed" class="ui-bar" data-inline="true">        
                                                                     
    </div><!-- /footer -->
            
</div> <!-- /options -->


</body>
</html>
